<head>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
</head>

<div class="container mt-5">
    <h1 class="text-center mb-4">Cadastro de Veículos</h1>
    <div id="alert" class="d-none"></div>
    <form id="formVeiculo">
        <div class="row g-3">
            <div class="col-sm-6 col-md-4">
                <label for="modelo" class="form-label">Modelo</label>
                <input type="text" class="form-control" id="modelo" placeholder="Ex: Fusca">
            </div>
            <div class="col-sm-6 col-md-2">
                <label for="ano" class="form-label">Ano/modelo</label>
                <select class="form-select" id="ano">
                    <option value="">Selecione</option>                    
                </select>
            </div>
            <div class="col-sm-6 col-md-2">
                <label for="preco" class="form-label">Preço</label>
                <input type="number" class="form-control" id="preco" placeholder="Ex: 30000">
            </div>
            <div class="col-sm-6 col-md-2">
                <label for="cor" class="form-label">Cor</label>
                <input type="text" class="form-control" id="cor" placeholder="Ex: Amarelo">
            </div>
            <div class="col-sm-6 col-md-2">
                <label for="quilometragem" class="form-label">Quilometragem</label>
                <input type="number" class="form-control" id="quilometragem" placeholder="Ex: 50000">
            </div>
            <div class="col-sm-6 col-md-4">
                <label for="potencia" class="form-label">Potência</label>
                <input type="number" class="form-control" id="potencia" placeholder="Ex: 50">
            </div>
            <div class="col-sm-6 col-md-4">
                <label for="motor" class="form-label">Motor</label>
                <input type="text" class="form-control" id="motor" placeholder="Ex: 1.3">
            </div>
            <div class="col-sm-6 col-md-4">
                <label for="cambio" class="form-label">Câmbio</label>
                <select class="form-select" id="cambio">
                    <option value="">Selecione</option>
                    <option value="Manual">Manual</option>
                    <option value="Automático">Automático</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="direcao" class="form-label">Direção</label>
                <select class="form-select" id="direcao">
                    <option value="">Selecione</option>
                    <option value="Hidráulica">Hidráulica</option>
                    <option value="Elétrica">Elétrica</option>
                    <option value="Mecânica">Mecânica</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="tracao" class="form-label">Tração</label>
                <select class="form-select" id="tracao">
                    <option value="">Selecione</option>
                    <option value="Traseira">Traseira</option>
                    <option value="Dianteira">Dianteira</option>
                    <option value="Integral">Integral</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="categoriaId" class="form-label">Categoria ID</label>
                <select class="form-select" id="categoriaId">
                    <option value="">Selecione</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="montadoraId" class="form-label">Montadora ID</label>
                <select class="form-select" id="montadoraId">
                    <option value="">Selecione</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="avaliacao" class="form-label">Avaliação</label>
                <input type="number" step="0.1" class="form-control" id="avaliacao" placeholder="Ex: 4.0">
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <div class="form-check me-4">
                    <input type="checkbox" class="form-check-input" id="destaque">
                    <label class="form-check-label" for="destaque">Destaque</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="disponivel" checked>
                    <label class="form-check-label" for="disponivel">Disponível</label>
                </div>
            </div>
            <div class="col-md-12">
                <label for="descricao" class="form-label">Descrição</label>
                <textarea class="form-control" id="descricao" rows="3" placeholder="Ex: Clássico e icônico."></textarea>
            </div>  
            <fieldset>
                <label class="form-label">Carregue as fotos do seu veículo</label>     
                <div class="col-md-12" style="display: flex; flex-wrap: wrap;" id="imagensVeiculos">
                    <label 
                        for="imagem" 
                        class="form-label" style="
                        background-position: center;
                        background-image: url(https://www.svgrepo.com/show/309379/camera-add.svg);
                        background-size: contain;
                        padding: 75px 50px 25px;
                        background-repeat: round;
                        display: initial;">
                    </label>
                    <input type="file" id="imagem" multiple style="display: none;">
                </div>
            </fieldset>
            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary">Cadastrar</button>
            </div>
        </div>
    </form>
</div>

<script>
$(document).ready(() => {
    $('#imagensVeiculos').sortable({
        placeholder: "ui-state-highlight",
        update: function (event, ui) {
            console.log('Nova ordem:', $('#imagensVeiculos').sortable('toArray'));
        }
    });

    const uploadImagens = async (imagens) => {
        try {
            let formdata = new FormData();
            formdata.append("file", imagens);

            let requestOptions = {
                method: 'POST',
                body: formdata,
                redirect: 'follow'
            };

            const response = await fetch("http://localhost:3037/upload", requestOptions);

            if (!response.ok) {
                throw new Error(`Erro no upload: ${response.statusText}`);
            }

            const result = await response.json();
            return result;

        } catch (error) {
            console.error('Erro ao fazer upload:', error);
            throw error;
        }
    };

    $('#imagem').on('change', function (e) {
        const files = e.target.files;
        const imagensVeiculos = $('#imagensVeiculos');

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            uploadImagens(file)
                .then(result => {
                    console.log('Imagem carregada:', result.url);
                    const imgElement = $(`
                        <div class="sortable-item" id="img-${i}">
                            <img src="${result.url}" class="img-thumbnail listaDeFotosVeiculos" style="width: 180px; margin: 5px;">
                        </div>
                    `);
                    imagensVeiculos.append(imgElement);
                })
                .catch(error => {
                    console.error('Erro no upload:', error);
                });
        }
    });

    const loadAnoModelo = () => {
        const currentYear = new Date().getFullYear();
        let ano_modelo = [];
        for (let year = currentYear; year >= 1920; year--) {
            ano_modelo.push(`<option value="${year} - ${year}">${year} - ${year}</option>`);
            ano_modelo.push(`<option value="${year} - ${year+1}">${year} - ${year+1}</option>`);
        }
        return ano_modelo;
    };

    $("#ano").empty();
    $("#ano").append(loadAnoModelo());

    $('#formVeiculo').on('submit', function (e) {
        e.preventDefault();

        let fotosSelecionadas = [];
        $('.listaDeFotosVeiculos').each(function () {
            fotosSelecionadas.push($(this).attr('src'));
        });

        const veiculo = {
            modelo: $('#modelo').val(),
            ano: parseInt($('#ano').val()),
            preco: parseFloat($('#preco').val()),
            descricao: $('#descricao').val(),
            cor: $('#cor').val(),
            quilometragem: parseInt($('#quilometragem').val()),
            potencia: parseInt($('#potencia').val()),
            motor: $('#motor').val(),
            cambio: $('#cambio').val(),
            direcao: $('#direcao').val(),
            tracao: $('#tracao').val(),
            categoriaId: parseInt($('#categoriaId').val()),
            montadoraId: parseInt($('#montadoraId').val()),
            avaliacao: parseFloat($('#avaliacao').val()),
            destaque: $('#destaque').is(':checked'),
            disponivel: $('#disponivel').is(':checked'),
            imagem: fotosSelecionadas
        };

        let myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");

        let dados = JSON.stringify(veiculo);

        let requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: dados,
            redirect: 'follow'
        };

        fetch("http://localhost:3000/veiculo", requestOptions)
            .then(response => response.json())
            .then(result => {
                console.log(result);
                exibirAlertaSucesso();
            })
            .catch(error => console.log('error', error));
    });

    const loadCategorias = async () => {
        try {
            const response = await fetch('http://localhost:3000/categoria');
            if (!response.ok) {
                throw new Error(`Erro ao carregar categorias: ${response.statusText}`);
            }
            const categorias = await response.json();

            const categoriaSelect = $('#categoriaId');
            categoriaSelect.empty(); 
            categoriaSelect.append('<option value="">Selecione</option>'); 
            categorias.forEach(categoria => {
                categoriaSelect.append(`<option value="${categoria.id}">${categoria.nome}</option>`);
            });
        } catch (error) {
            console.error('Erro ao carregar categorias:', error);
        }
    };

    loadCategorias();

    const loadMontadoras = async () => {
        try {
            const response = await fetch('http://localhost:3000/montadora');
            if (!response.ok) {
                throw new Error(`Erro ao carregar montadoras: ${response.statusText}`);
            }
            const montadoras = await response.json();

            const montadoraSelect = $('#montadoraId');
            montadoraSelect.empty(); 
            montadoraSelect.append('<option value="">Selecione</option>'); 
            montadoras.forEach(montadora => {
                montadoraSelect.append(`<option value="${montadora.id}">${montadora.nome}</option>`);
            });
        } catch (error) {
            console.error('Erro ao carregar montadoras:', error);
        }
    };  

    loadMontadoras();

});

const exibirAlertaSucesso = () => {
    const alerta = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Sucesso!</strong> Veículo cadastrado com sucesso.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    $('#alert').html(alerta).removeClass('d-none');

    $('.btn-close').on('click', () => {
        limparFormulario();
    });
};

const limparFormulario = () => {
    $('#formVeiculo')[0].reset();
    $('#imagensVeiculos').empty();
};
</script>
